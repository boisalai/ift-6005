# Database Documentation Generator

This document explains how we generate comprehensive documentation for our database columns using the `docoff.py` script (Database Column Documentation Generator).

This documentation will be used by a conversational agent to understand the database structure and generate SQL queries in response to user questions.

## Overview

See the `src/docoff.py` script for the full code.

The documentation generator uses Claude 3.5 Sonnet to analyze and document the columns in the Open Food Facts Canadian products database. For each column, it:
- Analyzes data structure and content
- Generates standardized documentation
- Creates example SQL queries
- Validates query correctness
- Stores documentation in a structured JSON format

## Key Components

### 1. SQL Execution Tool

The `DuckDBSearchTool` provides safe database access with the following features:
- Query execution with size limits
- Result formatting
- Error handling
- Query validation using sqlglot
- Standard response format in JSON

```python
def forward(self, query: str) -> str:
    """Execute SQL query and return results"""
    try:
        result = self.connection.sql(query)
        output = self.format_output(result.columns, result.fetchall())
        return json.dumps(output)
    except Exception as e:
        return json.dumps({"error": f"Unexpected error: {str(e)}"})
```

### 2. Web Search Tool

The `FoodGuideSearchTool` performs web searches in the Open Food Facts website to gather additional information about database columns.

Specifically, this tool searches for keywords provided by an agent on:
- [https://world.openfoodfacts.org/](https://world.openfoodfacts.org/)
- [https://github.com/openfoodfacts/](https://github.com/openfoodfacts/)

### 3. Documentation Writing Tool

The `WriteTool` manages the documentation JSON file:
- Creates/updates column documentation
- Validates document structure
- Maintains exactly 3 example queries per column
- Manages documentation versioning

The tool enforces the following structure for each column:
```python
column_doc = {
    "type": type,                    # Technical data type
    "description": description,      # Clear English description
    "examples": examples,            # Exactly 3 real examples
    "is_nullable": is_nullable,      # Boolean
    "common_queries": common_queries # Exactly 3 query examples
}
```

### 4. Documentation Agent

The database column documentation is generated by an agent. For each column, the agent:
1. Queries the column in the database
2. Searches the Open Food Facts website for additional column information
3. Proposes a column description
4. Generates typical SQL queries for the column
5. Adds the column documentation to the `columns_documentation.json` file

## Documentation Structure

The documentation is stored in a structured JSON format like this:

```json
{
    "tables": {
        "products": {
            "description": "Main table containing information about food products",
            "columns": {
                "product_name": {
                    "type": "STRUCT(lang VARCHAR, text VARCHAR)[]",
                    "description": "Product name in different languages",
                    "examples": [
                        "[{'lang': 'fr', 'text': 'Pain'}, {'lang': 'en', 'text': 'Bread'}]",
                        "[{'lang': 'en', 'text': 'Milk'}]",
                        "[{'lang': 'fr', 'text': 'Yaourt'}]"
                    ],
                    "is_nullable": true,
                    "common_queries": [
                        {
                            "description": "Get product name in French",
                            "sql": "SELECT code, UNNEST(LIST_FILTER(product_name, x -> x.lang = 'fr'))['text'] AS name FROM products LIMIT 1000"
                        },
                        {
                            "description": "Find missing translations",
                            "sql": "SELECT code FROM products WHERE ARRAY_LENGTH(product_name) < 2 LIMIT 1000"
                        },
                        {
                            "description": "Get products with multiple languages",
                            "sql": "SELECT code FROM products WHERE list_contains(list_transform(product_name, x -> x.lang), 'fr') LIMIT 1000"
                        }
                    ]
                }
                // ... other columns
            }
        }
    }
}
```

The documentation is saved in the `columns_documentation.json` file.

## Running the Documentation Generator

To generate documentation:
```bash
python docoff.py
```